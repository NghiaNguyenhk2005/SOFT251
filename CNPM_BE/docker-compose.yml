version: '3.8'

services:
  # HCMUT DATACORE - Port 8001
  datacore:
    build:
      context: ./datacore
      dockerfile: Dockerfile
    container_name: hcmut-datacore
    ports:
      - "8001:8001"
    environment:
      - PORT=8001
      - NODE_ENV=development
      - MONGO_URI=mongodb://admin:admin123@mongodb:27017/hcmut_datacore?authSource=admin
    depends_on:
      mongodb:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - cnpc-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # Mock HCMUT Library - Port 3002
  mock-library:
    build:
      context: ./mock_hcmut_library
      dockerfile: Dockerfile
    container_name: mock-hcmut-library
    ports:
      - "3002:3002"
    environment:
      - PORT=3002
      - NODE_ENV=development
    restart: unless-stopped
    networks:
      - cnpc-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3002/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # CAS SSO Server - Port 5001
  cas-sso:
    build:
      context: ./cas/server
      dockerfile: Dockerfile
    container_name: cas-sso-server
    ports:
      - "5001:5001"
    environment:
      - PORT=5001
      - NODE_ENV=production
      - MONGO_URI=mongodb://admin:admin123@mongodb:27017/cas_sso_db?authSource=admin
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=redis123
      - SESSION_SECRET=cas-sso-super-secret-key-change-in-production-2025
      - CORS_ORIGINS=http://localhost:5000,http://localhost:5173,http://localhost:3000
      - CLIENT_REDIRECT_URL=http://localhost:5000/api/v1/auth/callback
    depends_on:
      mongodb:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - cnpc-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:5001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Tutor System Backend - Port 5000
  # tutor-backend:
  #   build:
  #     context: ./tutor-system-backend
  #     dockerfile: Dockerfile
  #   container_name: tutor-system-backend
  #   ports:
  #     - "5000:5000"
  #   environment:
  #     - PORT=5000
  #     - NODE_ENV=development
  #     - MONGODB_URI=mongodb://admin:admin123@mongodb:27017/tutor_system?authSource=admin
  #     - JWT_SECRET=tutor-backend-jwt-super-secret-key-2025
  #     - JWT_EXPIRES_IN=1d
  #     # CAS SSO Integration
  #     - SSO_ENABLED=true
  #     - SSO_LOGIN_URL=http://localhost:5001/login
  #     - SSO_VALIDATE_URL=http://cas-sso:5001/api/validate
  #     - SSO_SERVICE_URL=http://localhost:5000/api/v1/auth/callback
  #     # DATACORE Integration
  #     - DATACORE_API_URL=http://datacore:8001/api
  #     # Library Integration
  #     - LIBRARY_API_URL=http://mock-library:3002/api
  #     # Redis
  #     - REDIS_ENABLED=false
  #     - REDIS_URL=redis://:redis123@redis:6379
  #   depends_on:
  #     mongodb:
  #       condition: service_healthy
  #     redis:
  #       condition: service_healthy
  #     cas-sso:
  #       condition: service_healthy
  #     datacore:
  #       condition: service_healthy
  #     mock-library:
  #       condition: service_healthy
  #   restart: unless-stopped
  #   networks:
  #     - cnpc-network
  #   healthcheck:
  #     test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:5000/health"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3
  #     start_period: 40s

  # MongoDB Database
  mongodb:
    image: mongo:7
    container_name: cnpc-mongodb
    ports:
      - "27017:27017"
    environment:
      - MONGO_INITDB_ROOT_USERNAME=admin
      - MONGO_INITDB_ROOT_PASSWORD=admin123
      - MONGO_INITDB_DATABASE=tutor_system
    volumes:
      - mongodb-data:/data/db
      - ./mongo-init:/docker-entrypoint-initdb.d
    restart: unless-stopped
    networks:
      - cnpc-network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis (for caching and sessions)
  redis:
    image: redis:7-alpine
    container_name: cnpc-redis
    ports:
      - "6379:6379"
    command: redis-server --requirepass redis123
    volumes:
      - redis-data:/data
    restart: unless-stopped
    networks:
      - cnpc-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

networks:
  cnpc-network:
    driver: bridge

volumes:
  mongodb-data:
    driver: local
  redis-data:
    driver: local
